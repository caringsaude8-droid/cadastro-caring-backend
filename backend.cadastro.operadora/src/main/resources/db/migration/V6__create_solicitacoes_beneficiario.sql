-- Tabela para solicitações de movimentação de beneficiários
CREATE TABLE SGI_SOLICITACOES_BENEFICIARIO (
    SOL_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

    -- Identificação da solicitação
    SOL_NUMERO VARCHAR2(20 CHAR) UNIQUE NOT NULL, -- Ex: SOL-2024-000001

    -- Referência ao beneficiário
    SOL_BEN_ID NUMBER NOT NULL,
    SOL_BEN_CPF VARCHAR2(11 CHAR) NOT NULL,
    SOL_BEN_NOME VARCHAR2(200 CHAR) NOT NULL,

    -- Tipo de movimentação
    SOL_TIPO VARCHAR2(10 CHAR) NOT NULL CHECK (SOL_TIPO IN ('INCLUSAO', 'ALTERACAO', 'EXCLUSAO')),

    -- Status da solicitação
    SOL_STATUS VARCHAR2(10 CHAR) DEFAULT 'PENDENTE' CHECK (SOL_STATUS IN ('PENDENTE', 'APROVADA', 'REJEITADA', 'CANCELADA')),

    -- Dados específicos por tipo
    SOL_MOTIVO_EXCLUSAO VARCHAR2(500 CHAR), -- Só para exclusões
    SOL_DADOS_JSON CLOB, -- Dados completos do beneficiário (JSON) para inclusão/alteração
    SOL_OBSERVACOES CLOB,

    -- Controle de datas
    SOL_DATA_SOLICITACAO DATE DEFAULT SYSDATE NOT NULL,
    SOL_DATA_APROVACAO DATE,
    SOL_DATA_EFETIVACAO DATE,

    -- Usuários envolvidos
    SOL_USUARIO_SOLICITANTE_ID NUMBER NOT NULL,
    SOL_USUARIO_SOLICITANTE_NOME VARCHAR2(100 CHAR) NOT NULL,
    SOL_APROVADOR_ID NUMBER,
    SOL_APROVADOR_NOME VARCHAR2(100 CHAR),

    -- Justificativas
    SOL_OBSERVACOES_SOLICITACAO CLOB,
    SOL_OBSERVACOES_APROVACAO CLOB,

    -- Timestamps de controle
    SOL_CREATED_AT DATE DEFAULT SYSDATE NOT NULL,
    SOL_UPDATED_AT DATE DEFAULT SYSDATE NOT NULL,

    -- Chaves estrangeiras
    CONSTRAINT FK_SOL_BENEFICIARIO FOREIGN KEY (SOL_BEN_ID) REFERENCES SGI_CAD_BENEFICIARIO(BEN_ID),
    CONSTRAINT FK_SOL_USUARIO FOREIGN KEY (SOL_USUARIO_SOLICITANTE_ID) REFERENCES SGI_USUARIOS(USU_ID)
);

-- Índices para performance
CREATE INDEX IDX_SOL_CPF ON SGI_SOLICITACOES_BENEFICIARIO(SOL_BEN_CPF);
CREATE INDEX IDX_SOL_STATUS_DATA ON SGI_SOLICITACOES_BENEFICIARIO(SOL_STATUS, SOL_DATA_SOLICITACAO);
CREATE INDEX IDX_SOL_USUARIO_TIPO ON SGI_SOLICITACOES_BENEFICIARIO(SOL_USUARIO_SOLICITANTE_ID, SOL_TIPO);

-- Sequence para numeração das solicitações
CREATE SEQUENCE SEQ_SOLICITACAO_NUMERO START WITH 1 INCREMENT BY 1;

-- Trigger para gerar número da solicitação automaticamente
CREATE OR REPLACE TRIGGER TRG_SOL_NUMERO
    BEFORE INSERT ON SGI_SOLICITACOES_BENEFICIARIO
    FOR EACH ROW
BEGIN
    IF :NEW.SOL_NUMERO IS NULL THEN
        SELECT 'SOL-' || TO_CHAR(SYSDATE, 'YYYY') || '-' || LPAD(SEQ_SOLICITACAO_NUMERO.NEXTVAL, 6, '0')
        INTO :NEW.SOL_NUMERO
        FROM DUAL;
    END IF;
END;
/

-- Trigger para atualizar timestamp
CREATE OR REPLACE TRIGGER TRG_SOL_UPDATED_AT
    BEFORE UPDATE ON SGI_SOLICITACOES_BENEFICIARIO
    FOR EACH ROW
BEGIN
    :NEW.SOL_UPDATED_AT := SYSDATE;
END;
/

-- ========================================
-- TABELA DE AUDITORIA/HISTÓRICO
-- ========================================
CREATE TABLE SGI_SOLICITACOES_HISTORICO (
    HIS_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    HIS_SOL_ID NUMBER NOT NULL,
    HIS_OPERACAO VARCHAR2(10 CHAR) NOT NULL CHECK (HIS_OPERACAO IN ('INSERT', 'UPDATE', 'DELETE')),
    HIS_STATUS_ANTERIOR VARCHAR2(10 CHAR),
    HIS_STATUS_NOVO VARCHAR2(10 CHAR),
    HIS_CAMPO_ALTERADO VARCHAR2(50 CHAR), -- Campo que foi alterado
    HIS_VALOR_ANTERIOR CLOB, -- Valor antes da alteração
    HIS_VALOR_NOVO CLOB, -- Valor após a alteração
    HIS_USUARIO_ID NUMBER, -- Usuário que fez a alteração
    HIS_USUARIO_NOME VARCHAR2(100 CHAR),
    HIS_DATA_OPERACAO DATE DEFAULT SYSDATE NOT NULL,
    HIS_IP_ORIGEM VARCHAR2(45 CHAR), -- IP de onde veio a alteração
    HIS_OBSERVACOES CLOB,
    HIS_SNAPSHOT_COMPLETO CLOB, -- JSON com estado completo do registro

    -- Chave estrangeira
    CONSTRAINT FK_HIS_SOLICITACAO FOREIGN KEY (HIS_SOL_ID)
        REFERENCES SGI_SOLICITACOES_BENEFICIARIO(SOL_ID) ON DELETE CASCADE
);

-- Índices para performance da auditoria
CREATE INDEX IDX_HIS_SOL_ID ON SGI_SOLICITACOES_HISTORICO(HIS_SOL_ID);
CREATE INDEX IDX_HIS_DATA_OPERACAO ON SGI_SOLICITACOES_HISTORICO(HIS_DATA_OPERACAO);
CREATE INDEX IDX_HIS_USUARIO ON SGI_SOLICITACOES_HISTORICO(HIS_USUARIO_ID);
CREATE INDEX IDX_HIS_STATUS ON SGI_SOLICITACOES_HISTORICO(HIS_STATUS_ANTERIOR, HIS_STATUS_NOVO);

-- ========================================
-- TRIGGERS PARA AUDITORIA AUTOMÁTICA
-- ========================================

-- Trigger para INSERT (criação de solicitação)
CREATE OR REPLACE TRIGGER TRG_SOL_AUDITORIA_INSERT
    AFTER INSERT ON SGI_SOLICITACOES_BENEFICIARIO
    FOR EACH ROW
BEGIN
    INSERT INTO SGI_SOLICITACOES_HISTORICO (
        HIS_SOL_ID,
        HIS_OPERACAO,
        HIS_STATUS_NOVO,
        HIS_CAMPO_ALTERADO,
        HIS_VALOR_NOVO,
        HIS_USUARIO_ID,
        HIS_USUARIO_NOME,
        HIS_OBSERVACOES,
        HIS_SNAPSHOT_COMPLETO
    ) VALUES (
        :NEW.SOL_ID,
        'INSERT',
        :NEW.SOL_STATUS,
        'CRIACAO',
        'Solicitação criada',
        :NEW.SOL_USUARIO_SOLICITANTE_ID,
        :NEW.SOL_USUARIO_SOLICITANTE_NOME,
        'Solicitação ' || :NEW.SOL_NUMERO || ' criada',
        '{"acao":"criacao","numero":"' || :NEW.SOL_NUMERO || '","tipo":"' || :NEW.SOL_TIPO || '","status":"' || :NEW.SOL_STATUS || '","empresaId":"' || NVL(TO_CHAR(:NEW.SOL_EMP_ID),'NULL') || '"}'
    );
END;
/

-- Trigger para UPDATE (aprovação/rejeição)
CREATE OR REPLACE TRIGGER TRG_SOL_AUDITORIA_UPDATE
    AFTER UPDATE ON SGI_SOLICITACOES_BENEFICIARIO
    FOR EACH ROW
BEGIN
    -- Registrar mudança de status
    IF :OLD.SOL_STATUS != :NEW.SOL_STATUS THEN
        INSERT INTO SGI_SOLICITACOES_HISTORICO (
            HIS_SOL_ID,
            HIS_OPERACAO,
            HIS_STATUS_ANTERIOR,
            HIS_STATUS_NOVO,
            HIS_CAMPO_ALTERADO,
            HIS_VALOR_ANTERIOR,
            HIS_VALOR_NOVO,
            HIS_USUARIO_ID,
            HIS_USUARIO_NOME,
            HIS_OBSERVACOES,
            HIS_SNAPSHOT_COMPLETO
        ) VALUES (
            :NEW.SOL_ID,
            'UPDATE',
            :OLD.SOL_STATUS,
            :NEW.SOL_STATUS,
            'SOL_STATUS',
            :OLD.SOL_STATUS,
            :NEW.SOL_STATUS,
            :NEW.SOL_APROVADOR_ID,
            :NEW.SOL_APROVADOR_NOME,
            CASE
                WHEN :NEW.SOL_STATUS = 'APROVADA' THEN 'Solicitação aprovada: ' || NVL(:NEW.SOL_OBSERVACOES_APROVACAO, 'Sem observações')
                WHEN :NEW.SOL_STATUS = 'REJEITADA' THEN 'Solicitação rejeitada: ' || NVL(:NEW.SOL_OBSERVACOES_APROVACAO, 'Sem motivo informado')
                ELSE 'Status alterado para ' || :NEW.SOL_STATUS
            END,
            '{"status_anterior":"' || :OLD.SOL_STATUS || '","status_novo":"' || :NEW.SOL_STATUS || '","empresaId":"' || NVL(TO_CHAR(:NEW.SOL_EMP_ID),'NULL') || '","data_aprovacao":"' || TO_CHAR(:NEW.SOL_DATA_APROVACAO, 'YYYY-MM-DD HH24:MI:SS') || '","aprovador":"' || NVL(:NEW.SOL_APROVADOR_NOME, 'Sistema') || '"}'
        );
    END IF;

    -- Registrar alterações do campo SOL_EMP_ID
    IF NVL(:OLD.SOL_EMP_ID, -1) != NVL(:NEW.SOL_EMP_ID, -1) THEN
        INSERT INTO SGI_SOLICITACOES_HISTORICO (
            HIS_SOL_ID,
            HIS_OPERACAO,
            HIS_CAMPO_ALTERADO,
            HIS_VALOR_ANTERIOR,
            HIS_VALOR_NOVO,
            HIS_USUARIO_ID,
            HIS_USUARIO_NOME,
            HIS_OBSERVACOES
        ) VALUES (
            :NEW.SOL_ID,
            'UPDATE',
            'SOL_EMP_ID',
            NVL(TO_CHAR(:OLD.SOL_EMP_ID),'NULL'),
            NVL(TO_CHAR(:NEW.SOL_EMP_ID),'NULL'),
            :NEW.SOL_APROVADOR_ID,
            :NEW.SOL_APROVADOR_NOME,
            'Empresa vinculada alterada'
        );
    END IF;

    -- Registrar outras alterações importantes
    IF NVL(:OLD.SOL_OBSERVACOES_APROVACAO, 'NULL') != NVL(:NEW.SOL_OBSERVACOES_APROVACAO, 'NULL') THEN
        INSERT INTO SGI_SOLICITACOES_HISTORICO (
            HIS_SOL_ID,
            HIS_OPERACAO,
            HIS_CAMPO_ALTERADO,
            HIS_VALOR_ANTERIOR,
            HIS_VALOR_NOVO,
            HIS_USUARIO_ID,
            HIS_USUARIO_NOME,
            HIS_OBSERVACOES
        ) VALUES (
            :NEW.SOL_ID,
            'UPDATE',
            'SOL_OBSERVACOES_APROVACAO',
            :OLD.SOL_OBSERVACOES_APROVACAO,
            :NEW.SOL_OBSERVACOES_APROVACAO,
            :NEW.SOL_APROVADOR_ID,
            :NEW.SOL_APROVADOR_NOME,
            'Observações de aprovação adicionadas/alteradas'
        );
    END IF;
END;
/

